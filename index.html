<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SP-WEB ULTIMATE RWD</title>
    <style>
        :root { --orange: #ff6600; --dark: #121212; --panel: #222; --lcd: #1d2b1d; --neon: #00ff41; --pad: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        /* Responsive Container */
        .sp-container { background: var(--panel); width: 98vw; max-width: 900px; padding: clamp(10px, 2vw, 20px); border-radius: 12px; border: 3px solid #333; display: flex; flex-direction: column; gap: 15px; transition: all 0.3s ease; }
        
        /* Utility Bar */
        .utility-bar { display: flex; justify-content: space-between; gap: 10px; }
        .btn-small { background: #333; color: #888; border: 1px solid #444; font-size: 9px; padding: 5px 10px; border-radius: 4px; cursor: pointer; text-transform: uppercase; }

        /* Top Section: LCD & Knobs */
        .top-section { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 600px) { .top-section { grid-template-columns: 1.5fr 1fr; } }

        .lcd { background: var(--lcd); color: var(--neon); padding: 12px; border: 3px inset #444; border-radius: 6px; font-size: clamp(10px, 1.5vw, 12px); min-height: 90px; position: relative; }
        #clip-light { position: absolute; top: 5px; right: 5px; font-size: 9px; color: #333; }
        #clip-light.active { color: red; text-shadow: 0 0 5px red; }

        /* Sidebar/Top-bar Transition */
        .main-engine-bay { display: flex; flex-direction: column; gap: 15px; }
        .bank-bar { display: flex; gap: 5px; }
        
        @media (min-width: 768px) {
            .main-engine-bay { flex-direction: row; }
            .bank-bar { flex-direction: column; width: 60px; }
        }

        .bank-btn { flex: 1; padding: 10px; background: #333; border: none; color: #888; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .bank-btn.active { background: var(--orange); color: white; box-shadow: 0 0 10px var(--orange); }

        /* The Grid */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: clamp(6px, 1.5vw, 12px); flex-grow: 1; }
        .pad { aspect-ratio: 1; background: var(--pad); border: none; border-bottom: 4px solid #000; border-radius: 8px; cursor: pointer; position: relative; transition: 0.05s; }
        .pad.has-sample { background: #444; }
        .pad.playing { background: white !important; box-shadow: 0 0 15px white; }
        .pad-label { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 8px; color: var(--orange); pointer-events: none; overflow: hidden; }

        /* Footer Controls */
        .footer-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 10px; background: #444; color: white; }

        /* Settings Modal */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid var(--orange); padding: 20px; z-index: 2000; display: none; flex-direction: column; gap: 10px; width: 280px; border-radius: 10px; box-shadow: 0 0 100px #000; }
        
        /* Fullscreen Mode Adjustments */
        :fullscreen .sp-container { width: 100vw; height: 100vh; max-width: none; border: none; border-radius: 0; }
    </style>
</head>
<body>

<div id="settings-modal" class="modal">
    <h3 style="margin:0; font-size:14px;">PAD EDIT</h3>
    <input type="text" id="p-name" placeholder="Name..." style="background:#000; color:white; border:1px solid #444; padding:8px;">
    <div style="font-size:10px; color:#888;">PITCH <input type="range" id="p-pitch" min="0.5" max="2" step="0.01" style="width:100%;"></div>
    <div style="font-size:10px; color:#888;">VOLUME <input type="range" id="p-vol" min="0" max="1.5" step="0.01" style="width:100%;"></div>
    <div style="display:flex; gap:5px;">
        <button id="m-btn" class="btn" style="flex:1" onclick="toggleMute()">MUTE</button>
        <button id="s-btn" class="btn" style="flex:1" onclick="toggleSolo()">SOLO</button>
    </div>
    <button class="btn" style="background:var(--orange);" onclick="closeSettings()">DONE</button>
</div>

<div class="sp-container">
    <div class="utility-bar">
        <button id="fs-btn" class="btn-small" onclick="toggleFullscreen()">FULLSCREEN</button>
        <button class="btn-small" style="color:#ff4444;" onclick="panic()">PANIC</button>
    </div>

    <div class="top-section">
        <div class="lcd">
            <div id="clip-light">LIMIT</div>
            <div id="display-bank">BANK A</div>
            <div id="display-status">READY</div>
        </div>
        <div style="display:grid; gap:8px;">
            <div style="font-size:9px; color:#888;">FILTER <input type="range" id="m-filter" min="100" max="15000" value="15000" style="width:100%;"></div>
            <div style="font-size:9px; color:#888;">DELAY <input type="range" id="m-delay" min="0" max="0.8" step="0.01" value="0.3" style="width:100%;"></div>
        </div>
    </div>

    <div class="main-engine-bay">
        <div class="bank-bar">
            <button class="bank-btn active" onclick="setBank('A')">A</button>
            <button class="bank-btn" onclick="setBank('B')">B</button>
            <button class="bank-btn" onclick="setBank('C')">C</button>
            <button class="bank-btn" onclick="setBank('D')">D</button>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <div class="footer-controls">
        <button class="btn" onclick="document.getElementById('file-in').click()">IMPORT</button>
        <button class="btn" onclick="autoChop()">CHOP 16</button>
        <button class="btn" id="rec-btn" onclick="toggleRecord()">REC SESSION</button>
    </div>
    <input type="file" id="file-in" hidden accept="audio/*">
</div>

<script>
let audioCtx, masterBus, lpFilter, limiter, delayNode, delayFeedback;
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A', editingIdx = null, lastBuf = null;
let mediaRec, chunks = [], isRec = false;

function init() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    lpFilter = audioCtx.createBiquadFilter();
    limiter = audioCtx.createDynamicsCompressor();
    delayNode = audioCtx.createDelay(2.0);
    delayFeedback = audioCtx.createGain();
    
    delayFeedback.gain.value = 0.4;
    delayNode.connect(delayFeedback);
    delayFeedback.connect(delayNode);
    delayNode.connect(masterBus);
    
    limiter.threshold.value = -1;
    lpFilter.connect(limiter);
    limiter.connect(masterBus);
    masterBus.connect(audioCtx.destination);

    ['A','B','C','D'].forEach(b => {
        for(let i=0; i<16; i++) banks[b][i] = { buffer: null, name: `PAD ${i+1}`, pitch: 1, vol: 1, mute: false, solo: false };
    });
    render();
    requestAnimationFrame(monitor);
}

function playPad(idx) {
    if (!audioCtx) init();
    const pad = banks[currentBank][idx];
    if (!pad.buffer) return;
    const anySolo = Object.values(banks[currentBank]).some(p => p.solo);
    if (pad.mute || (anySolo && !pad.solo)) return;

    const src = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    src.buffer = pad.buffer;
    src.playbackRate.value = pad.pitch;
    gain.gain.value = pad.vol;
    
    src.connect(gain);
    gain.connect(lpFilter);
    gain.connect(delayNode); // Send to delay

    document.getElementById(`pad-${idx}`).classList.add('playing');
    src.onended = () => document.getElementById(`pad-${idx}`).classList.remove('playing');
    src.start(0);
}

function render() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    for(let i=0; i<16; i++) {
        const pad = banks[currentBank][i];
        const btn = document.createElement('button');
        btn.id = `pad-${i}`;
        btn.className = `pad ${pad.buffer ? 'has-sample' : ''} ${pad.mute ? 'muted' : ''} ${pad.solo ? 'soloed' : ''}`;
        btn.innerHTML = `<span class="pad-label">${pad.name}</span>`;
        
        // Touch Optimized Performance
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); playPad(i); }, {passive: false});
        btn.onmousedown = (e) => { if(e.button === 0) playPad(i); };
        btn.oncontextmenu = (e) => { e.preventDefault(); openSettings(i); };
        grid.appendChild(btn);
    }
}

function openSettings(i) {
    editingIdx = i; const p = banks[currentBank][i];
    document.getElementById('settings-modal').style.display = 'flex';
    document.getElementById('p-name').value = p.name;
    document.getElementById('p-pitch').value = p.pitch;
    document.getElementById('p-vol').value = p.vol;
}

function closeSettings() {
    const p = banks[currentBank][editingIdx];
    p.name = document.getElementById('p-name').value;
    p.pitch = parseFloat(document.getElementById('p-pitch').value);
    p.vol = parseFloat(document.getElementById('p-vol').value);
    document.getElementById('settings-modal').style.display = 'none';
    render();
}

function setBank(b) {
    currentBank = b;
    document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === b));
    document.getElementById('display-bank').innerText = "BANK " + b;
    render();
}

function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
}

function panic() { masterBus.disconnect(); setTimeout(() => masterBus.connect(audioCtx.destination), 50); }

function monitor() {
    if(limiter) document.getElementById('clip-light').classList.toggle('active', limiter.reduction < -1);
    requestAnimationFrame(monitor);
}

document.getElementById('file-in').onchange = async (e) => {
    const arrayBuf = await e.target.files[0].arrayBuffer();
    lastBuf = await audioCtx.decodeAudioData(arrayBuf);
    banks[currentBank][0].buffer = lastBuf; render();
};

function autoChop() {
    if (!lastBuf) return;
    let sLen = lastBuf.duration / 16;
    for(let i=0; i<16; i++) {
        let slice = audioCtx.createBuffer(lastBuf.numberOfChannels, sLen * lastBuf.sampleRate, lastBuf.sampleRate);
        for(let c=0; c<lastBuf.numberOfChannels; c++) {
            slice.copyToChannel(lastBuf.getChannelData(c).subarray(i*sLen*lastBuf.sampleRate, (i+1)*sLen*lastBuf.sampleRate), c);
        }
        banks[currentBank][i].buffer = slice;
    }
    render();
}

document.getElementById('m-filter').oninput = (e) => lpFilter.frequency.value = e.target.value;
document.getElementById('m-delay').oninput = (e) => delayNode.delayTime.value = e.target.value;

const keys = {'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15};
window.onkeydown = (e) => { if(keys[e.key.toLowerCase()] !== undefined) playPad(keys[e.key.toLowerCase()]); };

// Auto-init on interaction
document.body.onclick = () => init();
render();
</script>
</body>
</html>
