<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SP-WEB ULTIMATE PLATINUM</title>
    <style>
        :root { --orange: #ff6600; --dark: #121212; --panel: #222; --lcd: #1d2b1d; --neon: #00ff41; --pad: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        .sp-container { 
            background: var(--panel); width: 98vw; max-width: 950px; height: 90vh; 
            padding: clamp(10px, 2vw, 20px); border-radius: 12px; border: 3px solid #333; 
            display: flex; flex-direction: column; gap: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .utility-bar { display: flex; justify-content: space-between; }
        .btn-small { background: #333; color: #888; border: 1px solid #444; font-size: 9px; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .learn-btn.active { background: var(--orange); color: white; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .top-section { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 650px) { .top-section { grid-template-columns: 1.5fr 1fr; } }

        .lcd { background: var(--lcd); color: var(--neon); padding: 12px; border: 3px inset #444; border-radius: 6px; position: relative; display: flex; flex-direction: column; }
        #visualizer { width: 100%; height: 50px; margin-top: auto; border-top: 1px solid rgba(0,255,65,0.2); }
        #clip-light { position: absolute; top: 5px; right: 8px; font-size: 9px; color: #2a332a; }
        #clip-light.active { color: #ff0000; text-shadow: 0 0 5px red; }

        .main-engine-bay { display: flex; flex-direction: column; gap: 15px; flex: 1; min-height: 0; }
        @media (min-width: 768px) { .main-engine-bay { flex-direction: row; } .bank-bar { flex-direction: column; width: 65px; } }

        .bank-bar { display: flex; gap: 5px; }
        .bank-btn { flex: 1; padding: 12px; background: #333; border: none; color: #888; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .bank-btn.active { background: var(--orange); color: white; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; }
        .pad { aspect-ratio: 1; background: var(--pad); border: none; border-bottom: 4px solid #000; border-radius: 8px; cursor: pointer; position: relative; }
        .pad.playing { background: white !important; box-shadow: 0 0 15px white; }
        .pad-label { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 9px; color: var(--orange); pointer-events: none; }

        .footer-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }
        .btn { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 9px; background: #444; color: white; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid var(--orange); padding: 20px; z-index: 2000; display: none; flex-direction: column; gap: 10px; width: 300px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="settings-modal" class="modal">
    <h3 style="margin:0; font-size:14px;">PAD SETUP</h3>
    <input type="text" id="p-name" style="background:#000; color:white; border:1px solid #444; padding:8px;">
    <div style="font-size:10px; color:#888;">PITCH <input type="range" id="p-pitch" min="0.5" max="2" step="0.01" style="width:100%;"></div>
    <div style="font-size:10px; color:#888;">VOLUME <input type="range" id="p-vol" min="0" max="1.5" step="0.01" style="width:100%;"></div>
    <div style="font-size:10px; color:#888;">ATTACK <input type="range" id="p-attack" min="0.001" max="1" step="0.001" style="width:100%;"></div>
    <div style="font-size:10px; color:#888;">RELEASE <input type="range" id="p-release" min="0.01" max="4" step="0.01" style="width:100%;"></div>
    <button class="btn" style="background:var(--orange);" onclick="closeSettings()">APPLY</button>
</div>

<div class="sp-container">
    <div class="utility-bar">
        <button id="fs-btn" class="btn-small" onclick="toggleFS()">FULLSCREEN</button>
        <button class="btn-small" style="color:#ff4444;" onclick="panic()">PANIC</button>
    </div>

    <div class="top-section">
        <div class="lcd">
            <div id="clip-light">LIMIT</div>
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span id="display-bank">BANK A</span>
                <span id="display-status">READY</span>
            </div>
            <canvas id="visualizer"></canvas>
        </div>
        <div style="display:grid; gap:8px;">
            <div style="display:flex; align-items:center; gap:5px;">
                <button class="btn-small learn-btn" onclick="startLearn('m-filter', this)">L</button>
                <div style="font-size:9px; color:#888; flex:1;">CUTOFF <input type="range" id="m-filter" min="100" max="15000" value="15000" style="width:100%;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <button class="btn-small learn-btn" onclick="startLearn('m-delay', this)">L</button>
                <div style="font-size:9px; color:#888; flex:1;">DELAY <input type="range" id="m-delay" min="0" max="0.8" step="0.01" value="0.3" style="width:100%;"></div>
            </div>
        </div>
    </div>

    <div class="main-engine-bay">
        <div class="bank-bar">
            <button class="bank-btn active" onclick="setBank('A')">A</button>
            <button class="bank-btn" onclick="setBank('B')">B</button>
            <button class="bank-btn" onclick="setBank('C')">C</button>
            <button class="bank-btn" onclick="setBank('D')">D</button>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <div class="footer-controls">
        <button class="btn" onclick="document.getElementById('f-in').click()">IMPORT</button>
        <button class="btn" onclick="saveProj()">SAVE PROJ</button>
        <button class="btn" onclick="document.getElementById('p-in').click()">LOAD PROJ</button>
        <button class="btn" id="rec-btn" onclick="toggleRec()" style="background:#600;">REC SESSION</button>
    </div>
</div>

<input type="file" id="f-in" hidden accept="audio/*"><input type="file" id="p-in" hidden accept=".json" onchange="loadProj(this.files[0])">

<script>
let audioCtx, masterBus, lpFilter, limiter, delayNode, delayFB, analyser, dataArray;
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A', editingIdx = null, lastBuf = null;
let mediaRec, chunks = [], isRec = false, midiLearning = null, midiMaps = {};

function init() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    lpFilter = audioCtx.createBiquadFilter();
    limiter = audioCtx.createDynamicsCompressor();
    delayNode = audioCtx.createDelay(2.0);
    delayFB = audioCtx.createGain();
    analyser = audioCtx.createAnalyser();

    delayFB.gain.value = 0.4;
    delayNode.connect(delayFB); delayFB.connect(delayNode);
    delayNode.connect(masterBus);
    lpFilter.connect(limiter); limiter.connect(masterBus);
    masterBus.connect(analyser); analyser.connect(audioCtx.destination);

    analyser.fftSize = 64; dataArray = new Uint8Array(analyser.frequencyBinCount);
    ['A','B','C','D'].forEach(b => { 
        for(let i=0; i<16; i++) banks[b][i] = { buffer: null, name: `PAD ${i+1}`, pitch: 1, vol: 0.8, attack: 0.005, release: 0.2 }; 
    });
    
    if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(m => { for (let i of m.inputs.values()) i.onmidimessage = handleMIDI; });
    render(); drawViz(); monitor();
}

function playPad(idx) {
    if (!audioCtx) init();
    const p = banks[currentBank][idx]; if (!p || !p.buffer) return;
    const src = audioCtx.createBufferSource(); const env = audioCtx.createGain();
    src.buffer = p.buffer; src.playbackRate.value = p.pitch;
    
    const now = audioCtx.currentTime;
    const atk = parseFloat(p.attack) || 0.005;
    const rel = parseFloat(p.release) || 0.2;
    const dur = (p.buffer.duration / p.pitch);

    env.gain.setValueAtTime(0, now);
    env.gain.linearRampToValueAtTime(p.vol, now + atk);
    env.gain.setValueAtTime(p.vol, now + Math.max(atk, dur - rel));
    env.gain.exponentialRampToValueAtTime(0.001, now + dur);

    src.connect(env); env.connect(lpFilter); env.connect(delayNode);
    const el = document.getElementById(`pad-${idx}`); if(el) el.classList.add('playing');
    src.onended = () => el.classList.remove('playing'); src.start(0);
}

function handleMIDI(m) {
    const [s, d1, d2] = m.data; const type = s & 0xf0;
    if (type === 144 && d2 > 0) playPad(d1 % 16);
    if (type === 176) {
        if (midiLearning) { midiMaps[d1] = midiLearning; midiLearning = null; document.querySelectorAll('.learn-btn').forEach(b => b.classList.remove('active')); }
        else if (midiMaps[d1]) {
            const el = document.getElementById(midiMaps[d1]);
            el.value = (d2 / 127) * (el.max - el.min) + parseFloat(el.min);
            el.dispatchEvent(new Event('input'));
        }
    }
}

function startLearn(id, btn) { midiLearning = id; btn.classList.add('active'); }

function drawViz() {
    requestAnimationFrame(drawViz); if(!analyser) return;
    const ctx = document.getElementById('visualizer').getContext('2d');
    analyser.getByteFrequencyData(dataArray); ctx.fillStyle = '#1d2b1d'; ctx.fillRect(0, 0, 300, 150);
    let x = 0; let bw = (300 / dataArray.length) * 2.5;
    for(let i=0; i<dataArray.length; i++) { let bh = dataArray[i] / 2; ctx.fillStyle = '#00ff41'; ctx.fillRect(x, 150 - bh, bw - 1, bh); x += bw; }
}

function render() {
    const g = document.getElementById('grid'); g.innerHTML = '';
    for(let i=0; i<16; i++) {
        const p = banks[currentBank][i]; const b = document.createElement('button');
        b.id = `pad-${i}`; b.className = `pad ${p.buffer?'has-sample':''}`;
        b.innerHTML = `<span class="pad-label">${p.name}</span>`;
        b.addEventListener('touchstart', (e)=>{ e.preventDefault(); playPad(i); }, {passive:false});
        b.onmousedown = (e)=>{ if(e.button===0) playPad(i); };
        b.oncontextmenu = (e)=>{ e.preventDefault(); editingIdx = i; 
            document.getElementById('settings-modal').style.display='flex'; 
            document.getElementById('p-name').value=p.name;
            document.getElementById('p-pitch').value=p.pitch;
            document.getElementById('p-vol').value=p.vol;
            document.getElementById('p-attack').value=p.attack;
            document.getElementById('p-release').value=p.release;
        };
        g.appendChild(b);
    }
}

function saveProj() { 
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(banks)], {type:'application/json'}));
    a.download = `PLATINUM-PROJ-${Date.now()}.json`; a.click(); 
}

function loadProj(f) { const r = new FileReader(); r.onload = (e) => { banks = JSON.parse(e.target.result); render(); }; r.readAsText(f); }

function toggleRec() {
    if(!isRec) {
        const d = audioCtx.createMediaStreamDestination(); masterBus.connect(d);
        mediaRec = new MediaRecorder(d.stream); mediaRec.ondataavailable = (e)=>chunks.push(e.data);
        mediaRec.onstop = ()=>{ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, {type:'audio/wav'})); a.download = `REC.wav`; a.click(); chunks = []; };
        mediaRec.start(); isRec = true; document.getElementById('rec-btn').innerText = "STOP";
    } else { mediaRec.stop(); isRec = false; document.getElementById('rec-btn').innerText = "RECORD SESSION"; }
}

function closeSettings() {
    const p = banks[currentBank][editingIdx]; 
    p.name = document.getElementById('p-name').value;
    p.pitch = parseFloat(document.getElementById('p-pitch').value); 
    p.vol = parseFloat(document.getElementById('p-vol').value);
    p.attack = parseFloat(document.getElementById('p-attack').value);
    p.release = parseFloat(document.getElementById('p-release').value);
    document.getElementById('settings-modal').style.display = 'none'; render();
}

function setBank(b) { currentBank = b; document.querySelectorAll('.bank-btn').forEach(x => x.classList.toggle('active', x.innerText===b)); render(); }
function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); }
function panic() { masterBus.disconnect(); setTimeout(()=>masterBus.connect(analyser), 50); }
function monitor() { if(limiter) document.getElementById('clip-light').classList.toggle('active', limiter.reduction < -1); requestAnimationFrame(monitor); }

document.getElementById('f-in').onchange = async (e) => { 
    lastBuf = await audioCtx.decodeAudioData(await e.target.files[0].arrayBuffer()); 
    banks[currentBank][0].buffer = lastBuf; render(); 
};
document.getElementById('m-filter').oninput = (e) => { if(lpFilter) lpFilter.frequency.value = e.target.value; };
document.getElementById('m-delay').oninput = (e) => { if(delayNode) delayNode.delayTime.value = e.target.value; };
window.onkeydown = (e) => { const k = {'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15}; if(k[e.key.toLowerCase()] !== undefined) playPad(k[e.key.toLowerCase()]); };
document.body.onclick = () => init(); render();
</script>
</body>
</html>
