<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SP-WEB ULTIMATE</title>
    <style>
        :root { --orange: #ff6600; --dark: #121212; --panel: #222; --lcd: #1d2b1d; --neon: #00ff41; --pad: #333; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        .sp-container { background: var(--panel); width: 100%; max-width: 480px; padding: 20px; border-radius: 15px; border: 3px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative;}
        
        /* LCD Display */
        .top-section { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-bottom: 20px; }
        .lcd { background: var(--lcd); color: var(--neon); padding: 10px; border: 3px inset #444; border-radius: 4px; font-size: 11px; height: 100px; position: relative; }
        #clip-light { position: absolute; top: 5px; right: 5px; font-size: 9px; color: #333; }
        #clip-light.active { color: red; text-shadow: 0 0 5px red; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .pad { aspect-ratio: 1; background: var(--pad); border: none; border-bottom: 4px solid #000; border-radius: 6px; cursor: pointer; position: relative; transition: 0.05s; }
        .pad.has-sample { background: #444; }
        .pad.playing { background: white !important; box-shadow: 0 0 15px white; }
        .pad.muted { opacity: 0.3; filter: grayscale(1); }
        .pad.soloed { border: 2px solid var(--neon); box-shadow: inset 0 0 8px var(--neon); }
        .pad-label { position: absolute; bottom: 4px; width: 100%; text-align: center; font-size: 8px; color: var(--orange); pointer-events: none; }

        /* Settings Modal */
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid var(--orange); padding: 20px; z-index: 1000; display: none; flex-direction: column; gap: 8px; width: 260px; border-radius: 10px; box-shadow: 0 0 100px #000; }
        .control-group { display: flex; flex-direction: column; font-size: 10px; color: #888; margin-top: 5px; }
        input[type=range] { accent-color: var(--orange); }

        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .btn-orange { background: var(--orange); color: white; }
        .bank-bar { display: flex; gap: 4px; margin-bottom: 12px; }
        .bank-btn { flex: 1; background: #333; color: #888; border: none; padding: 6px; cursor: pointer; border-radius: 3px; }
        .bank-btn.active { background: var(--orange); color: white; }

        .seq-bar { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin-top: 15px; height: 12px; }
        .step { background: #333; border-radius: 1px; }
        .step.active { background: var(--neon); }
    </style>
</head>
<body>

<div id="settings-modal" class="modal">
    <h3 style="margin:0; font-size:12px;">PAD <span id="edit-idx">1</span> EDIT</h3>
    <input type="text" id="pad-name" placeholder="Name..." style="background:#000; color:white; border:1px solid #444; padding:5px;">
    <div class="control-group">PITCH <input type="range" id="pad-pitch" min="0.5" max="2" step="0.01"></div>
    <div class="control-group">VOLUME <input type="range" id="pad-vol" min="0" max="1.5" step="0.01"></div>
    <div class="control-group">PAN <input type="range" id="pad-pan" min="-1" max="1" step="0.1"></div>
    <div style="display:flex; gap:5px; margin-top:5px;">
        <button id="mute-btn" class="btn" style="flex:1" onclick="toggleMute()">MUTE</button>
        <button id="solo-btn" class="btn" style="flex:1" onclick="toggleSolo()">SOLO</button>
    </div>
    <button class="btn btn-orange" onclick="closeSettings()" style="margin-top:10px;">DONE</button>
</div>

<div class="sp-container">
    <div class="top-section">
        <div class="lcd">
            <div id="clip-light">LIMIT</div>
            <div id="display-bank">BANK A</div>
            <div id="display-status">READY</div>
            <div id="display-time" style="margin-top:5px; color:#555;">00:00:00</div>
        </div>
        <div class="control-group">
            <div class="control-group">CUTOFF <input type="range" id="m-cutoff" min="100" max="15000" value="15000"></div>
            <div class="control-group">DELAY <input type="range" id="m-delay" min="0" max="0.8" step="0.01" value="0.3"></div>
            <button class="btn" style="background:#333; color:white; margin-top:5px;" onclick="toggleVinyl()">VINYL NOISE</button>
        </div>
    </div>

    <div class="bank-bar">
        <button class="bank-btn active" onclick="setBank('A')">A</button>
        <button class="bank-btn" onclick="setBank('B')">B</button>
        <button class="bank-btn" onclick="setBank('C')">C</button>
        <button class="bank-btn" onclick="setBank('D')">D</button>
    </div>

    <div class="grid" id="grid"></div>
    <div class="seq-bar" id="seq-bar"></div>

    <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
        <button class="btn" style="background:#444; color:white;" onclick="document.getElementById('audio-in').click()">IMPORT</button>
        <button class="btn" style="background:#444; color:white;" onclick="autoChop()">CHOP 16</button>
        <button class="btn" id="rec-master-btn" style="background:#500; color:white;" onclick="toggleMasterRecord()">REC SESSION</button>
    </div>
    <input type="file" id="audio-in" hidden accept="audio/*">
</div>

<script>
/* --- CORE AUDIO --- */
let audioCtx, masterBus, lpFilter, limiter, delayNode, delayFeedback, vinylNode, vinylGain;
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A', editingIdx = null, lastBuffer = null;
let mediaRecorder, recordedChunks = [], isRecording = false;

function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    lpFilter = audioCtx.createBiquadFilter();
    limiter = audioCtx.createDynamicsCompressor();

    // FX: Delay
    delayNode = audioCtx.createDelay(2.0);
    delayFeedback = audioCtx.createGain();
    delayFeedback.gain.value = 0.4;
    delayNode.connect(delayFeedback);
    delayFeedback.connect(delayNode);
    delayNode.connect(masterBus);

    // Limiter (The Wall)
    limiter.threshold.value = -1;
    limiter.ratio.value = 20;

    lpFilter.connect(limiter);
    limiter.connect(masterBus);
    masterBus.connect(audioCtx.destination);

    ['A','B','C','D'].forEach(b => {
        for(let i=0; i<16; i++) {
            banks[b][i] = { buffer: null, name: `PAD ${i+1}`, pitch: 1, vol: 1, pan: 0, mute: false, solo: false };
        }
    });
    render();
    requestAnimationFrame(monitor);
}

function playPad(idx) {
    if (!audioCtx) initAudio();
    const pad = banks[currentBank][idx];
    if (!pad.buffer) return;

    const anySolo = Object.values(banks[currentBank]).some(p => p.solo);
    if (pad.mute || (anySolo && !pad.solo)) return;

    const source = audioCtx.createBufferSource();
    const panner = audioCtx.createStereoPanner();
    const gain = audioCtx.createGain();

    source.buffer = pad.buffer;
    source.playbackRate.value = pad.pitch;
    panner.pan.value = pad.pan;
    gain.gain.value = pad.vol;

    source.connect(panner);
    panner.connect(gain);
    gain.connect(lpFilter);
    
    // Parallel send to delay
    const delaySend = audioCtx.createGain();
    delaySend.gain.value = 0.2;
    gain.connect(delaySend);
    delaySend.connect(delayNode);

    const el = document.getElementById(`pad-${idx}`);
    el.classList.add('playing');
    source.onended = () => el.classList.remove('playing');
    source.start(0);
}

/* --- LOGIC & UI --- */
function render() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    for(let i=0; i<16; i++) {
        const pad = banks[currentBank][i];
        const btn = document.createElement('button');
        btn.id = `pad-${i}`;
        btn.className = `pad ${pad.buffer ? 'has-sample' : ''} ${pad.mute ? 'muted' : ''} ${pad.solo ? 'soloed' : ''}`;
        btn.innerHTML = `<span class="pad-label">${pad.name}</span>`;
        btn.onmousedown = (e) => { if(e.button === 0) playPad(i); };
        btn.oncontextmenu = (e) => { e.preventDefault(); openSettings(i); };
        grid.appendChild(btn);
    }
}

function openSettings(i) {
    editingIdx = i;
    const pad = banks[currentBank][i];
    document.getElementById('settings-modal').style.display = 'flex';
    document.getElementById('pad-name').value = pad.name;
    document.getElementById('pad-pitch').value = pad.pitch;
    document.getElementById('pad-vol').value = pad.vol;
    document.getElementById('pad-pan').value = pad.pan;
    updateModalUI();
}

function closeSettings() {
    const pad = banks[currentBank][editingIdx];
    pad.name = document.getElementById('pad-name').value;
    pad.pitch = parseFloat(document.getElementById('pad-pitch').value);
    pad.vol = parseFloat(document.getElementById('pad-vol').value);
    pad.pan = parseFloat(document.getElementById('pad-pan').value);
    document.getElementById('settings-modal').style.display = 'none';
    render();
}

function toggleMute() { 
    banks[currentBank][editingIdx].mute = !banks[currentBank][editingIdx].mute;
    if(banks[currentBank][editingIdx].mute) banks[currentBank][editingIdx].solo = false;
    updateModalUI(); render();
}

function toggleSolo() { 
    banks[currentBank][editingIdx].solo = !banks[currentBank][editingIdx].solo;
    if(banks[currentBank][editingIdx].solo) banks[currentBank][editingIdx].mute = false;
    updateModalUI(); render();
}

function updateModalUI() {
    const p = banks[currentBank][editingIdx];
    document.getElementById('mute-btn').style.background = p.mute ? 'red' : '#444';
    document.getElementById('solo-btn').style.background = p.solo ? 'var(--neon)' : '#444';
}

function setBank(b) {
    currentBank = b;
    document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === b));
    document.getElementById('display-bank').innerText = "BANK " + b;
    render();
}

function toggleVinyl() {
    if (!audioCtx) initAudio();
    if (vinylNode) {
        vinylNode.stop(); vinylNode = null; return;
    }
    const bufSize = 2 * audioCtx.sampleRate;
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 0.02) + (Math.random() > 0.999 ? Math.random() * 0.1 : 0);
    vinylNode = audioCtx.createBufferSource();
    vinylGain = audioCtx.createGain();
    vinylNode.buffer = buf;
    vinylNode.loop = true;
    vinylGain.gain.value = 0.05;
    vinylNode.connect(vinylGain);
    vinylGain.connect(masterBus);
    vinylNode.start();
}

function monitor() {
    if(limiter) document.getElementById('clip-light').classList.toggle('active', limiter.reduction < -1);
    requestAnimationFrame(monitor);
}

/* --- EXPORT --- */
function toggleMasterRecord() {
    if (!isRecording) {
        const dest = audioCtx.createMediaStreamDestination();
        masterBus.connect(dest);
        mediaRecorder = new MediaRecorder(dest.stream);
        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/wav' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `BEAT-${Date.now()}.wav`;
            a.click();
            recordedChunks = [];
        };
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('rec-master-btn').innerText = "STOP & SAVE";
        document.getElementById('rec-master-btn').style.background = "red";
    } else {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('rec-master-btn').innerText = "REC SESSION";
        document.getElementById('rec-master-btn').style.background = "#500";
    }
}

/* --- UTILS --- */
document.getElementById('audio-in').onchange = async (e) => {
    const arrayBuf = await e.target.files[0].arrayBuffer();
    lastBuffer = await audioCtx.decodeAudioData(arrayBuf);
    banks[currentBank][0].buffer = lastBuffer;
    banks[currentBank][0].name = "SAMPLE";
    render();
};

function autoChop() {
    if (!lastBuffer) return;
    let sliceLen = lastBuffer.duration / 16;
    for(let i=0; i<16; i++) {
        let slice = audioCtx.createBuffer(lastBuffer.numberOfChannels, sliceLen * lastBuffer.sampleRate, lastBuffer.sampleRate);
        for(let c=0; c<lastBuffer.numberOfChannels; c++) {
            slice.copyToChannel(lastBuffer.getChannelData(c).subarray(i*sliceLen*lastBuffer.sampleRate, (i+1)*sliceLen*lastBuffer.sampleRate), c);
        }
        banks[currentBank][i].buffer = slice;
        banks[currentBank][i].name = "CHOP " + (i+1);
    }
    render();
}

document.getElementById('m-cutoff').oninput = (e) => lpFilter.frequency.value = e.target.value;
document.getElementById('m-delay').oninput = (e) => delayNode.delayTime.value = e.target.value;

const keyMap = {'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15};
window.onkeydown = (e) => { if(keyMap[e.key.toLowerCase()] !== undefined) playPad(keyMap[e.key.toLowerCase()]); };

// Startup
document.body.onclick = () => initAudio();
render();
</script>
</body>
</html>
