<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SP-WEB PRO SAMPLER</title>
    <style>
        :root { --orange: #ff6600; --dark: #121212; --panel: #222; --lcd: #1d2b1d; --neon: #00ff41; --pad: #333; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        .sp-container { background: var(--panel); width: 100%; max-width: 450px; padding: 20px; border-radius: 15px; border: 3px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* LCD & Knobs */
        .top-section { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 20px; }
        .lcd { background: var(--lcd); color: var(--neon); padding: 10px; border: 3px inset #444; border-radius: 4px; font-size: 11px; height: 80px; overflow: hidden; }
        .knobs { display: flex; flex-direction: column; gap: 10px; }
        .knob-row { display: flex; flex-direction: column; font-size: 9px; color: #888; }
        input[type=range] { accent-color: var(--orange); width: 100%; cursor: pointer; }

        /* Banks & Controls */
        .bank-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .bank-btn { flex: 1; padding: 10px; background: var(--pad); border: none; color: white; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .bank-btn.active { background: var(--orange); box-shadow: 0 0 10px var(--orange); }

        /* Pad Grid */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .pad { aspect-ratio: 1; background: var(--pad); border: none; border-bottom: 5px solid #000; border-radius: 8px; cursor: pointer; position: relative; transition: 0.05s; }
        .pad:active, .pad.active-press { transform: translateY(3px); border-bottom: 2px solid #000; background: var(--orange); }
        .pad.has-sample { border-color: #555; background: #444; }
        .pad.playing { background: white !important; box-shadow: 0 0 20px white; }
        .pad-num { position: absolute; top: 4px; left: 4px; font-size: 9px; color: #777; }

        /* Sequencer */
        .seq-bar { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin-top: 20px; height: 20px; }
        .step { background: #222; border: 1px solid #444; cursor: pointer; }
        .step.active-step { background: var(--neon); }
        .step.on { background: var(--orange); }

        /* Overlays */
        .guide-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; justify-content: center; align-items: center; text-align: center; }
        .btn { padding: 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .primary { background: var(--orange); color: white; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

<div id="guide" class="guide-overlay">
    <div style="max-width: 300px;">
        <h1 style="color:var(--orange)">SP-WEB PRO</h1>
        <p>1-4, Q-R, A-F, Z-V to Play<br>SPACE to Start Seq<br>Drag WAV/MP3 to Load</p>
        <button class="btn primary" onclick="startApp()">START ENGINE</button>
    </div>
</div>

<div class="sp-container">
    <div class="top-section">
        <div class="lcd">
            <div id="lcd-bank">BANK: A</div>
            <div id="lcd-status">READY</div>
            <canvas id="mini-wav" style="width:100%; height:30px; margin-top:5px;"></canvas>
        </div>
        <div class="knobs">
            <div class="knob-row">CUTOFF <input type="range" id="cutoff" min="100" max="15000" value="15000"></div>
            <div class="knob-row">RES <input type="range" id="res" min="0" max="20" value="1"></div>
            <div class="knob-row">SWING <input type="range" id="swing" min="0" max="0.5" step="0.01" value="0"></div>
        </div>
    </div>

    <div class="bank-bar">
        <button class="bank-btn active" onclick="switchBank('A')">A</button>
        <button class="bank-btn" onclick="switchBank('B')">B</button>
        <button class="bank-btn" onclick="switchBank('C')">C</button>
        <button class="bank-btn" onclick="switchBank('D')">D</button>
    </div>

    <div class="grid" id="pad-grid"></div>

    <div class="seq-bar" id="seq-bar"></div>

    <div style="margin-top:20px; display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#444; color:white;" onclick="document.getElementById('file-in').click()">IMPORT</button>
        <button class="btn" style="flex:1; background:#444; color:white;" onclick="autoChop()">CHOP 16</button>
        <button class="btn" style="flex:1; background:#900; color:white;" id="rec-btn">MIC REC</button>
    </div>
    <input type="file" id="file-in" hidden accept="audio/*">
</div>

<script>
/* --- AUDIO ENGINE --- */
let audioCtx;
let masterBus, lpFilter, compressor;
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A';
let currentStep = 0;
let isPlaying = false;
let nextNoteTime = 0;
let lastBuffer = null;

// Initialize Audio
function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    lpFilter = audioCtx.createBiquadFilter();
    compressor = audioCtx.createDynamicsCompressor();
    
    lpFilter.type = 'lowpass';
    lpFilter.connect(compressor);
    compressor.connect(masterBus);
    masterBus.connect(audioCtx.destination);
    
    // Setup Banks
    ['A','B','C','D'].forEach(b => {
        for(let i=0; i<16; i++) banks[b][i] = { buffer: null, mode: 'one-shot', node: null, gain: null };
    });
}

/* --- PLAYBACK LOGIC --- */
function playPad(idx, time = 0) {
    const pad = banks[currentBank][idx];
    if (!pad.buffer) return;

    // Choke & ADSR
    if (pad.node) { try { pad.node.stop(); } catch(e){} }

    const source = audioCtx.createBufferSource();
    const gainNode = audioCtx.createGain();
    source.buffer = pad.buffer;
    
    source.connect(gainNode);
    gainNode.connect(lpFilter);
    
    pad.node = source;
    pad.gain = gainNode;

    const visualPad = document.getElementById(`pad-${idx}`);
    visualPad.classList.add('playing');
    source.onended = () => visualPad.classList.remove('playing');

    source.start(time || audioCtx.currentTime);
}

function stopPad(idx) {
    const pad = banks[currentBank][idx];
    if (pad.mode === 'gate' && pad.node) {
        const now = audioCtx.currentTime;
        pad.gain.gain.linearRampToValueAtTime(0, now + 0.01);
        setTimeout(() => { try{pad.node.stop();}catch(e){} }, 20);
    }
}

/* --- SEQUENCER --- */
function scheduler() {
    while (nextNoteTime < audioCtx.currentTime + 0.1) {
        // Logic for triggering notes would go here based on a pattern grid
        advanceNote();
    }
    if (isPlaying) setTimeout(scheduler, 25);
}

function advanceNote() {
    const secondsPerBeat = 60.0 / 120; // 120 BPM
    let swing = parseFloat(document.getElementById('swing').value);
    let stepLen = 0.25 * secondsPerBeat;
    
    nextNoteTime += (currentStep % 2 !== 0) ? stepLen + (stepLen * swing) : stepLen - (stepLen * swing);
    currentStep = (currentStep + 1) % 16;
    
    // Update Playhead
    document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.toggle('active-step', i === currentStep);
    });
}

/* --- FILE & MIC --- */
async function handleFile(file) {
    const arrayBuf = await file.arrayBuffer();
    lastBuffer = await audioCtx.decodeAudioData(arrayBuf);
    banks[currentBank][0].buffer = lastBuffer;
    updateStatus("LOADED: " + file.name.substring(0,8));
    renderPads();
}

function autoChop() {
    if (!lastBuffer) return;
    let len = lastBuffer.duration / 16;
    for(let i=0; i<16; i++) {
        let slice = audioCtx.createBuffer(lastBuffer.numberOfChannels, len * lastBuffer.sampleRate, lastBuffer.sampleRate);
        for(let c=0; c<lastBuffer.numberOfChannels; c++) {
            slice.copyToChannel(lastBuffer.getChannelData(c).subarray(i*len*lastBuffer.sampleRate, (i+1)*len*lastBuffer.sampleRate), c);
        }
        banks[currentBank][i].buffer = slice;
    }
    updateStatus("AUTO CHOPPED");
    renderPads();
}

/* --- UI HELPERS --- */
function startApp() {
    initAudio();
    document.getElementById('guide').style.display = 'none';
    renderPads();
    renderSeq();
}

function renderPads() {
    const container = document.getElementById('pad-grid');
    container.innerHTML = '';
    for(let i=0; i<16; i++) {
        const p = document.createElement('button');
        p.id = `pad-${i}`;
        p.className = `pad ${banks[currentBank][i].buffer ? 'has-sample' : ''}`;
        p.innerHTML = `<span class="pad-num">${i+1}</span>`;
        p.onmousedown = () => playPad(i);
        p.onmouseup = () => stopPad(i);
        container.appendChild(p);
    }
}

function renderSeq() {
    const bar = document.getElementById('seq-bar');
    for(let i=0; i<16; i++) {
        const s = document.createElement('div');
        s.className = 'step';
        s.id = `step-${i}`;
        bar.appendChild(s);
    }
}

function switchBank(b) {
    currentBank = b;
    document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === b));
    document.getElementById('lcd-bank').innerText = "BANK: " + b;
    renderPads();
}

function updateStatus(txt) { document.getElementById('lcd-status').innerText = txt; }

/* --- CONTROLS --- */
document.getElementById('file-in').onchange = (e) => handleFile(e.target.files[0]);
document.getElementById('cutoff').oninput = (e) => lpFilter.frequency.value = e.target.value;
document.getElementById('res').oninput = (e) => lpFilter.Q.value = e.target.value;

// Keyboard Map
const keys = {'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15};
window.onkeydown = (e) => { 
    if(keys[e.key.toLowerCase()] !== undefined) {
        const idx = keys[e.key.toLowerCase()];
        playPad(idx);
        document.getElementById(`pad-${idx}`).classList.add('active-press');
    }
    if(e.code === 'Space') { 
        e.preventDefault(); isPlaying = !isPlaying; 
        if(isPlaying) { nextNoteTime = audioCtx.currentTime; scheduler(); }
    }
};
window.onkeyup = (e) => {
    if(keys[e.key.toLowerCase()] !== undefined) {
        const idx = keys[e.key.toLowerCase()];
        stopPad(idx);
        document.getElementById(`pad-${idx}`).classList.remove('active-press');
    }
};

// Drag & Drop
document.body.ondragover = (e) => e.preventDefault();
document.body.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

// PWA Service Worker
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
