<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MPC-WEB CHOP MASTER</title>
    <style>
        :root { 
            --mpc-beige: #c5c5b5; --mpc-dark: #a8a898; 
            --lcd-blue: #7098af; --lcd-text: #0b1a2a; 
            --pad-empty: #333; --pad-loaded: #a0a090; 
            --active-blue: #00ccff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #111; color: #333; font-family: 'Helvetica', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .sp-container { background: var(--mpc-beige); width: 98vw; max-width: 950px; height: 96vh; padding: 20px; border: 4px solid #888; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 10px; }
        .lcd { background: var(--lcd-blue); color: var(--lcd-text); padding: 12px; border: 4px inset #888; border-radius: 2px; display: flex; flex-direction: column; min-height: 130px; font-family: monospace; position: relative; }
        .lofi-toggle { position: absolute; right: 10px; top: 35px; background: #0b1a2a; color: var(--lcd-blue); border: 1px solid var(--lcd-blue); font-size: 10px; cursor: pointer; padding: 4px 8px; font-weight: bold; }
        .lofi-toggle.active { background: #ff3300; color: white; }
        .main-engine-bay { display: flex; flex: 1; gap: 10px; min-height: 0; }
        .bank-bar { display: flex; flex-direction: column; width: 60px; gap: 5px; }
        .bank-btn { flex: 1; background: #eee; border: 2px outset #fff; font-weight: bold; cursor: pointer; }
        .bank-btn.active { background: var(--active-blue); border-style: inset; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; flex: 1; background: #555; padding: 15px; border: 4px inset #333; }
        .pad { aspect-ratio: 1; background: var(--pad-empty); border: 3px solid #111; border-radius: 4px; cursor: pointer; position: relative; box-shadow: 4px 4px 0 #222; }
        .pad.has-sample { background: var(--pad-loaded); }
        .pad.playing { background: #fff !important; box-shadow: 0 0 20px var(--active-blue); }
        .pad-label { position: absolute; bottom: 6px; width: 100%; text-align: center; font-size: 10px; color: #fff; pointer-events: none; }
        .pad.has-sample .pad-label { color: #222; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--mpc-beige); border: 4px solid #444; padding: 20px; z-index: 2000; display: none; flex-direction: column; gap: 8px; width: 360px; box-shadow: 0 0 100px #000; }
        .btn { padding: 12px; border-radius: 2px; font-weight: bold; cursor: pointer; font-size: 10px; background: #dcdcdc; border: 2px outset #fff; text-transform: uppercase; }
        input[type=range] { width: 100%; height: 8px; appearance: none; background: #888; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #444; border: 2px outset #eee; }
    </style>
</head>
<body>

<div id="settings-modal" class="modal">
    <div style="font-weight:bold; border-bottom:1px solid #888; padding-bottom:5px;">PAD EDIT & CHOP</div>
    <div style="display:flex; gap:5px;">
        <button class="btn" style="flex:1; background:#444; color:white;" onclick="autoChop()">CHOP TO PADS</button>
        <input type="number" id="chop-count" value="4" min="2" max="16" style="width:50px; text-align:center;">
    </div>
    <canvas id="waveform-display" width="320" height="80" style="background:var(--lcd-blue); border:2px inset #666; margin:8px 0;"></canvas>
    <div style="font-size:11px;">LEVEL: <span id="v-vol">100%</span></div>
    <input type="range" id="p-vol" min="0" max="1.5" step="0.05" value="1.0">
    <div style="font-size:11px;">PITCH: <span id="v-pitch">1.0</span></div>
    <input type="range" id="p-pitch" min="0.5" max="2" step="0.01" value="1.0">
    <button class="btn" onclick="closeSettings()">DONE</button>
</div>

<div class="sp-container">
    <div class="lcd">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>CHOP MASTER v1.5</span>
            <span id="v-bpm-lcd">120 BPM</span>
        </div>
        <button id="lofi-btn" class="lofi-toggle" onclick="toggleLofi()">12-BIT: OFF</button>
        <div style="font-size:10px; margin-top:5px;">DRAG FILE TO PAD -> RIGHT CLICK -> CHOP</div>
    </div>
    <div class="main-engine-bay">
        <div class="bank-bar">
            <button class="bank-btn active" onclick="setBank('A')">A</button>
            <button class="bank-btn" onclick="setBank('B')">B</button>
            <button class="bank-btn" onclick="setBank('C')">C</button>
            <button class="bank-btn" onclick="setBank('D')">D</button>
        </div>
        <div class="grid" id="grid"></div>
    </div>
    <div class="footer">
        <button class="btn" onclick="saveProject()">SAVE</button>
        <button class="btn" onclick="panic()" style="background:#444; color:white;">STOP</button>
    </div>
</div>

<script>
let audioCtx, masterBus, limiter, lofiNode, activeSources = [];
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A', editingIdx = null, isLofi = false;

function init() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    limiter = audioCtx.createDynamicsCompressor();
    lofiNode = audioCtx.createScriptProcessor(4096, 1, 1);
    lofiNode.onaudioprocess = (e) => {
        let inP = e.inputBuffer.getChannelData(0), outP = e.outputBuffer.getChannelData(0);
        let step = Math.pow(0.5, 12);
        for (let i = 0; i < inP.length; i++) {
            outP[i] = isLofi ? step * Math.floor(inP[i] / step) : inP[i];
        }
    };
    masterBus.connect(lofiNode); lofiNode.connect(limiter); limiter.connect(audioCtx.destination);
    ['A','B','C','D'].forEach(b => { for(let i=0; i<16; i++) banks[b][i] = { buffer: null, name: `PAD ${i+1}`, pitch: 1, volume: 1.0 }; });
    render();
}

function autoChop() {
    const sourcePad = banks[currentBank][editingIdx];
    if (!sourcePad.buffer) return alert("No sample to chop!");
    
    const count = parseInt(document.getElementById('chop-count').value);
    const totalFrames = sourcePad.buffer.length;
    const sliceFrames = Math.floor(totalFrames / count);

    for (let i = 0; i < count; i++) {
        if (i >= 16) break; // Don't overflow the bank
        const sliceBuffer = audioCtx.createBuffer(1, sliceFrames, audioCtx.sampleRate);
        const data = sourcePad.buffer.getChannelData(0).slice(i * sliceFrames, (i + 1) * sliceFrames);
        sliceBuffer.copyToChannel(data, 0);
        
        banks[currentBank][i].buffer = sliceBuffer;
        banks[currentBank][i].name = `CHOP ${i+1}`;
    }
    closeSettings();
}

function playPad(idx) {
    if (!audioCtx) init();
    const p = banks[currentBank][idx]; if (!p || !p.buffer) return;
    const src = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    src.buffer = p.buffer; src.playbackRate.value = p.pitch;
    gain.gain.setValueAtTime(p.volume, audioCtx.currentTime);
    src.connect(gain); gain.connect(masterBus);
    src.start(0); activeSources.push(src);
    const el = document.getElementById(`pad-${idx}`); el.classList.add('playing');
    src.onended = () => { el.classList.remove('playing'); activeSources = activeSources.filter(s => s !== src); };
}

function render() {
    const g = document.getElementById('grid'); g.innerHTML = '';
    for(let i=0; i<16; i++) {
        const p = banks[currentBank][i]; const b = document.createElement('button');
        b.id = `pad-${i}`; b.className = `pad ${p.buffer ? 'has-sample' : ''}`;
        b.innerHTML = `<span class="pad-label">${p.name}</span>`;
        b.onmousedown = (e)=>{ if(e.button===0) playPad(i); };
        b.oncontextmenu = (e)=>{ e.preventDefault(); editingIdx = i; openModal(p); };
        b.ondrop = async (e) => { e.preventDefault(); b.classList.remove('drag-hover'); const f = e.dataTransfer.files[0]; if (f) { const ab = await f.arrayBuffer(); banks[currentBank][i].buffer = await audioCtx.decodeAudioData(ab); banks[currentBank][i].name = f.name.substring(0,8); render(); } };
        b.ondragover = (e) => { e.preventDefault(); b.classList.add('drag-hover'); };
        b.ondragleave = () => b.classList.remove('drag-hover');
        g.appendChild(b);
    }
}

function openModal(p) {
    document.getElementById('p-vol').value = p.volume; 
    document.getElementById('p-pitch').value = p.pitch; 
    document.getElementById('settings-modal').style.display='flex'; 
    drawWaveform(p.buffer);
}

function closeSettings() { 
    const p = banks[currentBank][editingIdx]; 
    p.pitch = parseFloat(document.getElementById('p-pitch').value); 
    p.volume = parseFloat(document.getElementById('p-vol').value);
    document.getElementById('settings-modal').style.display = 'none'; render(); 
}

function drawWaveform(b) { const c = document.getElementById('waveform-display'), x = c.getContext('2d'); x.clearRect(0,0,320,80); if(!b) return; x.strokeStyle="#0b1a2a"; x.lineWidth=1; x.beginPath(); const d = b.getChannelData(0), s = Math.ceil(d.length/320); for(let i=0; i<320; i++) x.lineTo(i, 40+d[i*s]*35); x.stroke(); }
function panic() { activeSources.forEach(s => { try { s.stop(); } catch(e) {} }); activeSources = []; document.querySelectorAll('.pad').forEach(p => p.classList.remove('playing')); }
function setBank(b) { currentBank = b; document.querySelectorAll('.bank-btn').forEach(x => x.classList.toggle('active', x.innerText===b)); render(); }
function toggleLofi() { isLofi = !isLofi; document.getElementById('lofi-btn').classList.toggle('active', isLofi); }
document.body.onclick = () => init(); render();
</script>
</body>
</html>
