<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOALA GLOBAL SEQUENCER</title>
    <style>
        :root { 
            --koala-red: #ff3b30; --koala-green: #4cd964; --koala-blue: #007aff;
            --pad-empty: #1a1a1a; --pad-loaded: #a2a2a2; --lcd-bg: #111;
        }
        * { box-sizing: border-box; user-select: none; font-family: 'Courier New', monospace; }
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #fff; overflow: hidden; }
        
        .master-container { background: #d1d1c4; width: 98vw; max-width: 900px; height: 98vh; padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 8px; border: 3px solid #999; }
        
        .lcd { background: var(--lcd-bg); color: var(--koala-green); padding: 10px; border-radius: 6px; border: 4px inset #555; display: grid; grid-template-columns: repeat(3, 1fr); align-items: center; text-align: center; }
        .lcd-val { font-size: 18px; font-weight: bold; }
        .lcd-label { font-size: 8px; text-transform: uppercase; color: #888; }

        .bank-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bank-btn { background: #444; color: #fff; border: 2px outset #666; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .bank-btn.active { background: var(--koala-blue); border-style: inset; box-shadow: 0 0 10px var(--koala-blue); }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 8px; flex: 1; }
        .pad { background: var(--pad-empty); border: 2px solid #000; border-radius: 8px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .pad.has-sample { background: var(--pad-loaded); border-color: #eee; }
        .pad.playing { background: #fff !important; transform: scale(0.95); transition: 0.05s; }
        .pad.recording { background: var(--koala-red) !important; animation: blink 0.2s infinite; }
        .pad-num { position: absolute; top: 4px; left: 6px; font-size: 9px; color: #555; font-weight: bold; }

        .btn-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .btn { background: #333; color: #fff; border: 2px outset #555; padding: 14px; border-radius: 4px; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        .btn.active { background: var(--koala-red); color: white; border-style: inset; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="master-container">
    <div class="lcd">
        <div><span class="lcd-label">ACTIVE BANK</span><div class="lcd-val" id="bank-disp">A</div></div>
        <div><span class="lcd-label">SEQUENCE</span><div class="lcd-val" id="seq-status">STOPPED</div></div>
        <div><span class="lcd-label">BPM</span><div class="lcd-val" id="bpm-disp">120</div></div>
    </div>

    <div class="bank-row">
        <button class="bank-btn active" id="btn-A" onclick="switchBank('A')">BANK A</button>
        <button class="bank-btn" id="btn-B" onclick="switchBank('B')">BANK B</button>
        <button class="bank-btn" id="btn-C" onclick="switchBank('C')">BANK C</button>
        <button class="bank-btn" id="btn-D" onclick="switchBank('D')">BANK D</button>
    </div>

    <div class="grid" id="grid"></div>

    <div class="btn-row">
        <button class="btn" id="play-btn" onclick="togglePlay()">PLAY</button>
        <button class="btn" id="rec-btn" onclick="toggleRec()">REC</button>
        <button class="btn" onclick="clearSeq()">CLEAR SEQ</button>
        <button class="btn" style="background:#222" onclick="panic()">STOP ALL</button>
    </div>
</div>

<script>
let audioCtx, masterBus;
let banks = { A: {}, B: {}, C: {}, D: {} };
let currentBank = 'A';
let bpm = 120, isPlaying = false, isRec = false, startTime, sequence = [];
let mediaRec, chunks = [];

function init() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain(); masterBus.connect(audioCtx.destination);
    ['A','B','C','D'].forEach(b => {
        for(let i=0; i<16; i++) banks[b][i] = { buffer: null };
    });
    render(); loopEngine();
}

function switchBank(b) {
    currentBank = b;
    document.getElementById('bank-disp').innerText = b;
    ['A','B','C','D'].forEach(bankID => {
        document.getElementById('btn-' + bankID).classList.toggle('active', bankID === b);
    });
    render();
}

function render() {
    const g = document.getElementById('grid'); g.innerHTML = '';
    const data = banks[currentBank];
    for(let i=0; i<16; i++) {
        const p = data[i]; const b = document.createElement('div');
        b.id = `pad-${i}`;
        b.className = `pad ${p.buffer ? 'has-sample' : ''}`;
        b.innerHTML = `<span class="pad-num">${i+1}</span>`;
        b.onmousedown = () => { if(!audioCtx) init(); if(!p.buffer) startRec(i); else triggerPad(i, true); };
        b.onmouseup = () => stopRec();
        g.appendChild(b);
    }
}

function triggerPad(idx, manual = false, bank = currentBank) {
    const p = banks[bank][idx]; if (!p || !p.buffer) return;
    
    const src = audioCtx.createBufferSource();
    src.buffer = p.buffer;
    src.connect(masterBus);
    src.start(0);

    // Visual feedback for the current bank only
    if (bank === currentBank) {
        const el = document.getElementById(`pad-${idx}`);
        if (el) {
            el.classList.add('playing');
            src.onended = () => el.classList.remove('playing');
        }
    }

    if (manual && isRec) {
        let t = (audioCtx.currentTime - startTime) % ((60/bpm)*4);
        sequence.push({ bank, idx, time: t, played: false });
    }
}

function loopEngine() {
    if (isPlaying || isRec) {
        if (!startTime) startTime = audioCtx.currentTime;
        let loopLen = (60 / bpm) * 4;
        let pos = (audioCtx.currentTime - startTime) % loopLen;
        
        sequence.forEach(n => {
            if (!n.played && pos >= n.time && pos < n.time + 0.05) { 
                triggerPad(n.idx, false, n.bank); n.played = true; 
            }
        });
        if (pos < 0.02) sequence.forEach(n => n.played = false);
    }
    requestAnimationFrame(loopEngine);
}

async function startRec(idx) {
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec = new MediaRecorder(s); chunks = [];
    mediaRec.ondataavailable = e => chunks.push(e.data);
    mediaRec.onstop = async () => {
        banks[currentBank][idx].buffer = await audioCtx.decodeAudioData(await (new Blob(chunks)).arrayBuffer());
        render();
    };
    mediaRec.start();
    document.getElementById(`pad-${idx}`).classList.add('recording');
}

function stopRec() { if(mediaRec && mediaRec.state === "recording") mediaRec.stop(); }

function togglePlay() { 
    if(!audioCtx) init(); 
    isPlaying = !isPlaying; 
    document.getElementById('play-btn').classList.toggle('active', isPlaying);
    document.getElementById('seq-status').innerText = isPlaying ? "PLAYING" : "STOPPED";
    if(isPlaying) startTime = audioCtx.currentTime; 
}

function toggleRec() { 
    if(!audioCtx) init(); 
    isRec = !isRec; 
    document.getElementById('rec-btn').classList.toggle('active', isRec);
    document.getElementById('seq-status').innerText = isRec ? "RECORDING" : (isPlaying ? "PLAYING" : "STOPPED");
    if(isRec) { isPlaying = true; document.getElementById('play-btn').classList.add('active'); startTime = audioCtx.currentTime; }
}

function panic() { isPlaying = isRec = false; document.getElementById('play-btn').classList.remove('active'); document.getElementById('rec-btn').classList.remove('active'); document.getElementById('seq-status').innerText = "STOPPED"; }
function clearSeq() { sequence = []; }

render();
</script>
</body>
</html>
